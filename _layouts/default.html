import React, { useState, useEffect } from 'react';
import Papa from 'papaparse';
import _ from 'lodash';

const CATEGORIES = {
  'GENERAL GOVERNMENT': [
    'Moderator - 114',
    'Select Board -122',
    'Town Admin - 129',
    'Finance Committee - 131',
    'Accountant - 135',
    'Assessor - 141',
    'Treasurer Collector - 149',
    'Information Technology - 155',
    'Town Clerk - 161',
    'Building & Maintenance - 192'
  ],
  'PUBLIC SAFETY': [
    'Police - 210',
    'Fire - 220',
    'Emergency Management - 291',
    'Animal Control - 292',
    'Tree Warden - 294',
    'Dispatch - 299'
  ],
  'PUBLIC SERVICES': [
    'Snow and Ice - 423',
    'Street Lights - 424',
    'Cemetery - 491',
    'Land Use - 241'
  ],
  'HUMAN SERVICES': [
    'Senior Center - 541',
    'Veterans - 543'
  ],
  'CULTURE & RECREATION': [
    'Library - 610',
    'Recreation - 630',
    'Agricultural Commission - 690',
    'Historical Commission - 691'
  ],
  'EDUCATION': [
    'School - 300'
  ],
  'DEBT': [
    'Debt - Short-Term Interest - 750',
    'Debt - Short Term Principal 750',
    'Debt - Long-Term Principal - 751',
    'Debt - Long-Term Interest - 752',
    'Debt - School Roof Principal',
    'Debt - School Roof Interest'
  ],
  'UNCLASSIFIED': [
    'Cherry Sheet Assessment - 820',
    'Worcester Regional Retirement - 911',
    'Unemployment - 913',
    'Health insurance - 914',
    'Medicare - 916',
    'Liability Insurance - 945',
    'Offsets and Overlay - 999'
  ]
};

const BudgetDisplay = () => {
  const [budgetData, setBudgetData] = useState({});
  const [selectedCategory, setSelectedCategory] = useState('GENERAL GOVERNMENT');
  const [categoryTotals, setCategoryTotals] = useState({});
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const fetchData = async () => {
      try {
        const response = await fetch('https://raw.githubusercontent.com/NBoudreauMA/FY26/main/docs/budget.csv');
        const text = await response.text();
        
        Papa.parse(text, {
          header: true,
          skipEmptyLines: true,
          complete: (results) => {
            processData(results.data);
            setLoading(false);
          }
        });
      } catch (err) {
        setError('Error loading budget data: ' + err.message);
        setLoading(false);
      }
    };

    fetchData();
  }, []);

  const processData = (data) => {
    const processed = {};
    const totals = {};
    let currentDept = null;
    let deptData = [];

    // Process row by row
    data.forEach(row => {
      if (row['_1'] && !row['_1'].includes('GOVERNMENT') && !row['_1'].includes('PUBLIC SAFETY')) {
        // New department found
        if (currentDept && deptData.length > 0) {
          // Store previous department data
          for (const [category, depts] of Object.entries(CATEGORIES)) {
            if (depts.includes(currentDept)) {
              processed[category] = processed[category] || {};
              processed[category][currentDept] = deptData;
            }
          }
        }
        currentDept = row['_1'];
        deptData = [];
      }
      
      if (currentDept && (row['_4'] || row['_3'])) {
        deptData.push(row);
      }
    });

    // Store last department
    if (currentDept && deptData.length > 0) {
      for (const [category, depts] of Object.entries(CATEGORIES)) {
        if (depts.includes(currentDept)) {
          processed[category] = processed[category] || {};
          processed[category][currentDept] = deptData;
        }
      }
    }

    // Calculate category totals
    Object.entries(processed).forEach(([category, depts]) => {
      totals[category] = {
        'FY24 ACTUAL': 0,
        'FY25 REQUESTED': 0,
        'FY26 DEPT': 0
      };

      Object.values(depts).forEach(items => {
        const totalRow = items.find(row => row['_4'] === 'TOTAL');
        if (totalRow) {
          ['FY24 ACTUAL', 'FY25 REQUESTED', 'FY26 DEPT'].forEach(col => {
            const value = totalRow[col]?.replace(/[$,]/g, '') || '0';
            totals[category][col] += parseFloat(value);
          });
        }
      });
    });

    setBudgetData(processed);
    setCategoryTotals(totals);
  };

  const formatCurrency = (value) => {
    if (!value) return '-';
    if (typeof value === 'string' && value.startsWith('$')) return value;
    const num = typeof value === 'string' ? parseFloat(value.replace(/[$,]/g, '')) : value;
    return num.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
  };

  if (loading) return (
    <div className="flex items-center justify-center h-64">
      <p className="text-lg">Loading budget data...</p>
    </div>
  );

  if (error) return (
    <div className="flex items-center justify-center h-64">
      <p className="text-red-600">{error}</p>
    </div>
  );

  return (
    <div className="max-w-7xl mx-auto p-4">
      <h1 className="text-3xl font-bold mb-6 text-gray-800">FY26 Budget Analysis</h1>
      
      {/* Category Navigation */}
      <div className="mb-6">
        <div className="flex flex-wrap gap-2">
          {Object.keys(CATEGORIES).map(category => (
            <button
              key={category}
              onClick={() => setSelectedCategory(category)}
              className={`px-6 py-3 rounded-lg font-semibold ${
                selectedCategory === category
                  ? 'bg-purple-700 text-white'
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              <div>{category}</div>
              <div className="text-sm font-normal">
                {formatCurrency(categoryTotals[category]?.['FY26 DEPT'])}
              </div>
            </button>
          ))}
        </div>
      </div>

      {/* Category Data */}
      <div className="space-y-8">
        {budgetData[selectedCategory] && Object.entries(budgetData[selectedCategory]).map(([dept, items]) => (
          <div key={dept} className="bg-white rounded-lg shadow-md p-6">
            <h3 className="text-xl font-medium mb-4 text-gray-600 border-b pb-2">{dept}</h3>
            
            <div className="overflow-x-auto">
              <table className="min-w-full table-auto">
                <thead>
                  <tr className="bg-purple-700 text-white">
                    <th className="px-4 py-2 text-left">Description</th>
                    <th className="px-4 py-2 text-right">FY24 Actual</th>
                    <th className="px-4 py-2 text-right">FY25 Requested</th>
                    <th className="px-4 py-2 text-right">FY26 Dept</th>
                    <th className="px-4 py-2 text-right">Change ($)</th>
                    <th className="px-4 py-2 text-right">Change (%)</th>
                  </tr>
                </thead>
                <tbody>
                  {items.map((item, idx) => (
                    <tr key={idx} className={`border-t ${item['_4'] === 'TOTAL' ? 'bg-gray-50 font-semibold' : ''}`}>
                      <td className="px-4 py-2">{item['_4'] || item['_3'] || '-'}</td>
                      <td className="px-4 py-2 text-right">{formatCurrency(item['FY24 ACTUAL'])}</td>
                      <td className="px-4 py-2 text-right">{formatCurrency(item['FY25 REQUESTED'])}</td>
                      <td className="px-4 py-2 text-right">{formatCurrency(item['FY26 DEPT'])}</td>
                      <td className="px-4 py-2 text-right">{formatCurrency(item['CHANGE ($)'])}</td>
                      <td className="px-4 py-2 text-right">{item['CHANGE (%)'] || '-'}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        ))}

        {/* Category Summary */}
        <div className="mt-8 p-4 bg-gray-50 rounded-lg">
          <h3 className="text-lg font-semibold mb-4">Category Total</h3>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <p className="text-sm text-gray-600">FY24 Actual</p>
              <p className="text-lg font-medium">
                {formatCurrency(categoryTotals[selectedCategory]?.['FY24 ACTUAL'])}
              </p>
            </div>
            <div>
              <p className="text-sm text-gray-600">FY25 Requested</p>
              <p className="text-lg font-medium">
                {formatCurrency(categoryTotals[selectedCategory]?.['FY25 REQUESTED'])}
              </p>
            </div>
            <div>
              <p className="text-sm text-gray-600">FY26 Dept Request</p>
              <p className="text-lg font-medium">
                {formatCurrency(categoryTotals[selectedCategory]?.['FY26 DEPT'])}
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default BudgetDisplay;
